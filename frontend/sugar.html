<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>บันทึกค่าน้ำตาล</title>
        <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="css/sugar.css"/>
    </head>

    <body>
        <div class="container">
            <div class="header">
                <div class="icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h1>บันทึกค่าน้ำตาลในเลือด</h1>
            </div>

            <form id="sugarForm">
                <!-- Meal Timing Section -->
                <div class="sugar-input-section">
                    <label class="input-label">ช่วงเวลา</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input
                                id="type"
                                type="radio"
                                name="mealTiming"
                                value="before"
                            />
                            <span>ก่อนอาหาร</span>
                        </label>
                        <label class="radio-option">
                            <input
                                id="type"
                                type="radio"
                                name="mealTiming"
                                value="after"
                            />
                            <span>หลังอาหาร</span>
                        </label>
                    </div>
                </div>

                <!-- Time of Day Section -->
                <div class="sugar-input-section">
                    <label class="input-label">เวลา</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input
                                id="period"
                                type="radio"
                                name="timeOfDay"
                                value="morning"
                            />
                            <span>เช้า</span>
                        </label>
                        <label class="radio-option">
                            <input
                                id="period"
                                type="radio"
                                name="timeOfDay"
                                value="evening"
                            />
                            <span>เย็น</span>
                        </label>
                    </div>
                </div>

                <div class="sugar-input-section">
                    <label class="input-label">กรอกค่าน้ำตาลในเลือด</label>
                    <div class="sugar-input-wrapper">
                        <input
                            type="number"
                            id="sugar"
                            name="sugar"
                            class="sugar-input"
                            required
                            min="20"
                            max="600"
                            placeholder="0"
                        />
                        <span class="sugar-unit">mg/dL</span>
                    </div>
                    <div class="range-indicator">
                        <div class="range-item">
                            <div class="range-dot low"></div>
                            <span>ต่ำ (&lt;70)</span>
                        </div>
                        <div class="range-item">
                            <div class="range-dot normal"></div>
                            <span>ปกติ (70-140)</span>
                        </div>
                        <div class="range-item">
                            <div class="range-dot high"></div>
                            <span>สูง (140-200)</span>
                        </div>
                        <div class="range-item">
                            <div class="range-dot very-high"></div>
                            <span>สูงมาก (&gt;200)</span>
                        </div>
                    </div>
                </div>

                <div id="statusDisplay" class="status-display hidden">
                    <i
                        id="statusIcon"
                        class="status-icon fas fa-question-circle"
                    ></i>
                    <div id="statusText" class="status-text">-</div>
                    <div id="statusDesc" class="status-desc">-</div>
                </div>

                <button type="submit" class="submit-btn">
                    <div class="btn-content">
                        <div class="loading-spinner"></div>
                        <i class="fas fa-save"></i>
                        <span class="btn-text">บันทึกข้อมูล</span>
                    </div>
                </button>
            </form>
        </div>

        <script>
            // Sugar level evaluation function
            function evaluateSugarLevel(value) {
                const sugar = parseInt(value);

                if (sugar < 70) {
                    return {
                        status: "low",
                        icon: "fa-arrow-down",
                        text: "ระดับน้ำตาลต่ำ",
                        desc: "ควรรับประทานอาหารหรือเครื่องดื่มหวาน",
                    };
                } else if (sugar <= 140) {
                    return {
                        status: "normal",
                        icon: "fa-check-circle",
                        text: "ระดับน้ำตาลปกติ",
                        desc: "ค่าน้ำตาลในช่วงที่เหมาะสม",
                    };
                } else if (sugar <= 200) {
                    return {
                        status: "high",
                        icon: "fa-exclamation-triangle",
                        text: "ระดับน้ำตาลสูง",
                        desc: "ควรควบคุมการรับประทาน และออกกำลังกาย",
                    };
                } else {
                    return {
                        status: "very-high",
                        icon: "fa-exclamation-circle",
                        text: "ระดับน้ำตาลสูงมาก",
                        desc: "ควรปรึกษาแพทย์ และควบคุมอาหารอย่างเข้มงวด",
                    };
                }
            }

            // Update status display
            function updateStatusDisplay(value) {
                const statusDisplay = document.getElementById("statusDisplay");
                const statusIcon = document.getElementById("statusIcon");
                const statusText = document.getElementById("statusText");
                const statusDesc = document.getElementById("statusDesc");

                if (!value) {
                    statusDisplay.classList.add("hidden");
                    return;
                }

                const evaluation = evaluateSugarLevel(value);

                // Remove all status classes
                statusDisplay.className = "status-display";

                // Add new status class
                statusDisplay.classList.add(`status-${evaluation.status}`);
                statusDisplay.classList.remove("hidden");

                // Update content
                statusIcon.className = `status-icon fas ${evaluation.icon}`;
                statusText.textContent = evaluation.text;
                statusDesc.textContent = evaluation.desc;
            }

            document.addEventListener("DOMContentLoaded", async () => {
                try {
                    await liff.init({ liffId: "2008029649-pVZ4jaV5" });

                    // ✅ ฟังก์ชันดึง userId (ใช้เหมือนหน้า index)
                    async function getUserId() {
                        if (!liff.isLoggedIn()) {
                            console.log(
                                "User not logged in → redirecting to login..."
                            );
                            liff.login({ redirectUri: window.location.href });
                            return null;
                        }
                        try {
                            const profile = await liff.getProfile();
                            console.log("Got user:", profile.displayName);
                            return profile.userId;
                        } catch (err) {
                            console.log("Error getting profile:", err);
                            if (
                                err.message &&
                                (err.message.includes("token") ||
                                    err.message.includes("401") ||
                                    err.message.includes("unauthorized"))
                            ) {
                                console.log(
                                    "Token expired → logout and re-login..."
                                );
                                liff.logout();
                                liff.login({
                                    redirectUri: window.location.href,
                                });
                                return null;
                            }
                            throw err;
                        }
                    }

                    // ✅ ตรวจสอบ userId
                    const userId = await getUserId();
                    if (!userId) return;

                    console.log("User ID:", userId);

                    // --- Elements ---
                    const sugarInput = document.getElementById("sugar");
                    const form = document.getElementById("sugarForm");
                    const submitBtn = document.querySelector(".submit-btn");
                    const btnText = submitBtn.querySelector(".btn-text");
                    const btnIcon = submitBtn.querySelector("i.fa-save");
                    const loadingSpinner =
                        submitBtn.querySelector(".loading-spinner");

                    // --- ฟังก์ชัน update indicator ---
                    const mealTimingInputs = document.querySelectorAll(
                        'input[name="mealTiming"]'
                    );
                    mealTimingInputs.forEach((input) => {
                        input.addEventListener("change", () => {
                            updateRangeIndicator(input.value);
                            if (sugarInput.value)
                                updateStatusDisplay(sugarInput.value);
                        });
                    });

                    sugarInput.addEventListener("input", (e) => {
                        updateStatusDisplay(e.target.value);
                    });

                    // --- Submit handler ---
                    form.addEventListener("submit", async (e) => {
                        e.preventDefault();

                        const sugar = parseInt(sugarInput.value);
                        const mealTiming = document.querySelector(
                            'input[name="mealTiming"]:checked'
                        );
                        const timeOfDay = document.querySelector(
                            'input[name="timeOfDay"]:checked'
                        );

                        if (!sugar || sugar < 20 || sugar > 600) {
                            return Swal.fire({
                                title: "ค่าไม่ถูกต้อง",
                                text: "กรุณากรอกค่าน้ำตาลระหว่าง 20–600 mg/dL",
                                icon: "warning",
                                confirmButtonColor: "#0c7e47",
                            });
                        }
                        if (!mealTiming) {
                            return Swal.fire({
                                title: "กรุณาเลือกช่วงเวลา",
                                text: "กรุณาเลือกว่าเป็นก่อน/หลังอาหาร",
                                icon: "warning",
                                confirmButtonColor: "#0c7e47",
                            });
                        }
                        if (!timeOfDay) {
                            return Swal.fire({
                                title: "กรุณาเลือกเวลา",
                                text: "กรุณาเลือกเช้า/เย็น",
                                icon: "warning",
                                confirmButtonColor: "#0c7e47",
                            });
                        }

                        // show loading
                        submitBtn.disabled = true;
                        btnText.textContent = "กำลังบันทึก...";
                        btnIcon.style.display = "none";
                        loadingSpinner.style.display = "inline-block";

                        try {
                            const currentUserId = await getUserId();
                            if (!currentUserId)
                                throw new Error("SESSION_EXPIRED");

                            const payload = {
                                userId: currentUserId,
                                sugar,
                                mealTiming: mealTiming.value,
                                timeOfDay: timeOfDay.value,
                            };
                            console.log("Sending:", payload);

                            const res = await fetch(
                                "https://sugar-tracker-eo64.onrender.com/sugar",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(payload),
                                }
                            );

                            const result = await res.json();
                            console.log("Response:", result);

                            if (result.success) {
                                await Swal.fire({
                                    title: "บันทึกสำเร็จ!",
                                    text: "บันทึกข้อมูลค่าน้ำตาลแล้ว",
                                    icon: "success",
                                    confirmButtonColor: "#0c7e47",
                                    timer: 2500,
                                    timerProgressBar: true,
                                });
                                form.reset();
                                updateStatusDisplay("");
                            } else if (result.isDuplicate) {
                                await Swal.fire({
                                    title: "ข้อมูลซ้ำ!",
                                    text: result.message,
                                    icon: "warning",
                                    confirmButtonColor: "#ffc107",
                                });
                            } else if (result.notRegistered) {
                                await Swal.fire({
                                    title: "ยังไม่ได้ลงทะเบียน",
                                    text: "กรุณาลงทะเบียนก่อนใช้งาน",
                                    icon: "error",
                                    confirmButtonColor: "#0c7e47",
                                }).then(
                                    () =>
                                        (window.location.href =
                                            "/register.html")
                                );
                            } else {
                                await Swal.fire({
                                    title: "แจ้งเตือน",
                                    text:
                                        result.message ||
                                        "เกิดข้อผิดพลาดในการบันทึก",
                                    icon: "warning",
                                    confirmButtonColor: "#0c7e47",
                                });
                            }
                        } catch (err) {
                            console.error("Submit error:", err);
                            if (err.message !== "SESSION_EXPIRED") {
                                await Swal.fire({
                                    title: "เกิดข้อผิดพลาด",
                                    text: "ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้",
                                    icon: "error",
                                    confirmButtonColor: "#0c7e47",
                                });
                            }
                        } finally {
                            submitBtn.disabled = false;
                            btnText.textContent = "บันทึกข้อมูล";
                            btnIcon.style.display = "inline-block";
                            loadingSpinner.style.display = "none";
                        }
                    });

                    // ✅ เช็ค session ทุก 10 นาที
                    setInterval(async () => {
                        try {
                            await getUserId();
                        } catch (err) {
                            console.log("Session check failed:", err);
                        }
                    }, 10 * 60 * 1000);
                } catch (err) {
                    console.error("LIFF Init Error:", err);
                    await Swal.fire({
                        title: "เกิดข้อผิดพลาด",
                        text: "ไม่สามารถเชื่อมต่อกับ LINE ได้",
                        icon: "error",
                        confirmButtonColor: "#0c7e47",
                    }).then(() => window.location.reload());
                }
            });

            // จัดการเมื่อหน้าเว็บกลับมา visible (หลังจาก login)
            document.addEventListener("visibilitychange", () => {
                if (!document.hidden) {
                    // เมื่อหน้าเว็บกลับมา visible หลังจาก login
                    setTimeout(() => {
                        if (
                            typeof liff !== "undefined" &&
                            liff.isReady() &&
                            liff.isLoggedIn()
                        ) {
                            console.log(
                                "User returned from login - reloading page"
                            );
                            window.location.reload();
                        }
                    }, 1000);
                }
            });

            // เพิ่ม event listener สำหรับการกลับมาจาก LINE login
            window.addEventListener("focus", () => {
                if (
                    typeof liff !== "undefined" &&
                    liff.isReady() &&
                    liff.isLoggedIn()
                ) {
                    console.log("Window focused and user is logged in");
                    // รอสักครู่แล้ว reload เพื่อให้ได้ userId ใหม่
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            });
        </script>
    </body>
</html>
